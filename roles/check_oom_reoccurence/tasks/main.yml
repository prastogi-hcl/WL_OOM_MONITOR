- name: sleep for a specified interval
  command: sleep '{{ sleep_interval }}'

- name: Find the latest WebLogic log file
  shell: "ls -1t {{ weblogic_log_path }}/{{ weblogic_log_file }} | head -n 1"
  register: latest_log_file

- name: Search for OutOfMemoryError in latest log file
  shell: "awk -v d=\"$(date '+%b %d, %Y %H:%M:%S')\" '$0 >= d && /OutOfMemoryError/' {{ latest_log_file.stdout }}"
  register: oom_errors
  changed_when: false

- name: Print OutOfMemoryError logs on screen
  debug:
    msg: "{{ oom_errors.stdout_lines }}"
  when: oom_errors.stdout | length > 0

- name: Set OOM reoccurrence status
  set_fact:
    oom_reoccurred: "{{ oom_errors.stdout | length > 0 and ansible_local.oom_detected is defined and ansible_local.oom_detected == 'true' }}"

- name: Mark OOM occurrence
  set_fact:
    oom_detected: "{{ oom_errors.stdout | length > 0 }}"
